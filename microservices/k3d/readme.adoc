= K3D

link:https://k3d.io/[K3D] is a minimal stack for Kubernetes.

== Overview

=== Cluster management

.Installation of pre-requisits
[source,bash]
----
# Install kubectl
$ curl -LO https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl
$ chmod +x ./kubectl
$ sudo mv ./kubectl /usr/local/bin/kubectl
$ kubectl version --client
Client Version: version.Info{Major:"1", Minor:"20", GitVersion:"v1.20.0", GitCommit:"af46c47ce925f4c4ad5cc8d1fca46c7b77d13b38", GitTreeState:"clean", BuildDate:"2020-12-08T17:59:43Z", GoVersion:"go1.15.5", Compiler:"gc", Platform:"linux/amd64"}

# Install latest stable
$ wget -q -O - https://raw.githubusercontent.com/rancher/k3d/main/install.sh | bash
$ k3d --version
k3d version v3.4.0
k3s version v1.19.4-k3s1 (default)

# Helm charts
$ curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash
----

.Cluster creation
[source,bash]
----
# Create a cluster with 3 nodes
$ k3d cluster create mycluster --servers 3
INFO[0000] Created network 'k3d-mycluster'              
INFO[0000] Created volume 'k3d-mycluster-images'        
INFO[0000] Creating initializing server node            
INFO[0000] Creating node 'k3d-mycluster-server-0'       
INFO[0012] Creating node 'k3d-mycluster-server-1'       
INFO[0027] Creating node 'k3d-mycluster-server-2'       
INFO[0041] Creating LoadBalancer 'k3d-mycluster-serverlb' 
INFO[0043] (Optional) Trying to get IP of the docker host and inject it into the cluster as 'host.k3d.internal' for easy access 
INFO[0049] Successfully added host record to /etc/hosts in 4/4 nodes and to the CoreDNS ConfigMap 
INFO[0049] Cluster 'mycluster' created successfully!    
INFO[0049] You can now use it like this:                
kubectl cluster-info

# Check this Cluster details
$ kubectl cluster-info
Kubernetes control plane is running at https://0.0.0.0:33227
CoreDNS is running at https://0.0.0.0:33227/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
Metrics-server is running at https://0.0.0.0:33227/api/v1/namespaces/kube-system/services/https:metrics-server:/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.

# Load config for kubectl
$ k3d kubeconfig merge mycluster --switch-context
/home/clement/.k3d/kubeconfig-mycluster.yaml

$ kubectl get nodes
$ NAME                     STATUS   ROLES         AGE   VERSION
k3d-mycluster-server-0   Ready    etcd,master   95s   v1.19.4+k3s1
k3d-mycluster-server-1   Ready    etcd,master   80s   v1.19.4+k3s1
k3d-mycluster-server-2   Ready    etcd,master   65s   v1.19.4+k3s1

$ docker ps -a
CONTAINER ID        IMAGE                      COMMAND                  CREATED              STATUS              PORTS                                                                                     NAMES
531fd29cbdfc        rancher/k3d-proxy:v3.4.0   "/bin/sh -c nginx-pr…"   About a minute ago   Up About a minute   80/tcp, 0.0.0.0:33227->6443/tcp                                                           k3d-mycluster-serverlb
a9cff36391d3        rancher/k3s:v1.19.4-k3s1   "/bin/k3s server --t…"   About a minute ago   Up About a minute                                                                                             k3d-mycluster-server-2
61d8ab22b78c        rancher/k3s:v1.19.4-k3s1   "/bin/k3s server --t…"   About a minute ago   Up About a minute                                                                                             k3d-mycluster-server-1
494a0bf8b7ba        rancher/k3s:v1.19.4-k3s1   "/bin/k3s server --c…"   2 minutes ago        Up 2 minutes                                                                                                  k3d-mycluster-server-0

# Check after some time deploying ...
$ kubectl get pods --all-namespaces
NAMESPACE     NAME                                     READY   STATUS      RESTARTS   AGE
kube-system   coredns-66c464876b-2b7tc                 1/1     Running     1          11m
kube-system   helm-install-traefik-b5fnh               0/1     Completed   0          11m
kube-system   local-path-provisioner-7ff9579c6-x4vpm   1/1     Running     1          11m
kube-system   metrics-server-7b4f8b595-szj7q           1/1     Running     1          11m
kube-system   svclb-traefik-5cckz                      2/2     Running     0          5m28s
kube-system   svclb-traefik-8kxfb                      2/2     Running     0          5m28s
kube-system   svclb-traefik-m2npx                      2/2     Running     0          5m28s
kube-system   traefik-5dd496474-kjm8g                  1/1     Running     0          5m28s
----

=== Deployment

Following the tutorial link:https://codeburst.io/creating-a-local-development-kubernetes-cluster-with-k3s-and-traefik-proxy-7a5033cb1c2d[CodeBurst K3D Whoami]

[source,bash]
----
$ k3d cluster create cluster-whoami --api-port 127.0.0.1:6443 -p 80:80@loadbalancer -p 443:443@loadbalancer --k3s-server-arg "--no-deploy=traefik"
INFO[0000] Created network 'k3d-cluster-whoami'         
INFO[0000] Created volume 'k3d-cluster-whoami-images'   
INFO[0001] Creating node 'k3d-cluster-whoami-server-0'  
INFO[0008] Creating LoadBalancer 'k3d-cluster-whoami-serverlb' 
INFO[0010] (Optional) Trying to get IP of the docker host and inject it into the cluster as 'host.k3d.internal' for easy access 
INFO[0014] Successfully added host record to /etc/hosts in 2/2 nodes and to the CoreDNS ConfigMap 
INFO[0014] Cluster 'cluster-whoami' created successfully! 
INFO[0014] You can now use it like this:                
kubectl cluster-info

$ k3d kubeconfig merge cluster-whoami --switch-context
/home/clement/.k3d/kubeconfig-cluster-whoami.yaml

$ kubectl get nodes
NAME                          STATUS   ROLES    AGE   VERSION
k3d-cluster-whoami-server-0   Ready    master   68s   v1.19.4+k3s1

# Wait and see after some times ...
$ kubectl get pods --all-namespaces
NAMESPACE     NAME                                     READY   STATUS    RESTARTS   AGE
kube-system   local-path-provisioner-7ff9579c6-2kbc8   1/1     Running   0          2m6s
kube-system   metrics-server-7b4f8b595-5g299           1/1     Running   0          2m6s
kube-system   coredns-66c464876b-sfg9d                 1/1     Running   0          2m6s

# Add Traefik
$ helm repo add traefik https://containous.github.io/traefik-helm-chart
"traefik" has been added to your repositories
$ helm install traefik traefik/traefik
W1212 22:18:10.602576   28728 warnings.go:67] apiextensions.k8s.io/v1beta1 CustomResourceDefinition is deprecated in v1.16+, unavailable in v1.22+; use apiextensions.k8s.io/v1 CustomResourceDefinition
...
NAME: traefik
LAST DEPLOYED: Sat Dec 12 22:18:13 2020
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE: None

# Wait and see after some times ...
$ kubectl get pods --all-namespaces
NAMESPACE     NAME                                     READY   STATUS    RESTARTS   AGE
kube-system   local-path-provisioner-7ff9579c6-2kbc8   1/1     Running   0          4m33s
kube-system   metrics-server-7b4f8b595-5g299           1/1     Running   0          4m33s
kube-system   coredns-66c464876b-sfg9d                 1/1     Running   0          4m33s
default       svclb-traefik-rwcfr                      2/2     Running   1          2m5s
default       traefik-5fc4947cf9-cnnf9                 1/1     Running   0          2m5s

# Deploy Whoami service
$ kubectl create deploy whoami --image containous/whoami
deployment.apps/whoami created

# Wait and see after some times ...
$ kubectl get pods --all-namespaces
NAMESPACE     NAME                                     READY   STATUS    RESTARTS   AGE
kube-system   local-path-provisioner-7ff9579c6-2kbc8   1/1     Running   0          5m14s
kube-system   metrics-server-7b4f8b595-5g299           1/1     Running   0          5m14s
kube-system   coredns-66c464876b-sfg9d                 1/1     Running   0          5m14s
default       svclb-traefik-rwcfr                      2/2     Running   1          2m46s
default       traefik-5fc4947cf9-cnnf9                 1/1     Running   0          2m46s
default       whoami-84f56668f5-lnwvl                  1/1     Running   0          23s

$ kubectl expose deploy whoami --port 80
service/whoami exposed

$ kubectl apply -f k3d-demo-whoami-ingress-80.yml 
Warning: networking.k8s.io/v1beta1 Ingress is deprecated in v1.19+, unavailable in v1.22+; use networking.k8s.io/v1 Ingress
ingress.networking.k8s.io/whoami created

$ kubectl port-forward $(kubectl get pods --selector "app.kubernetes.io/name=traefik" --output=name) 9000:9000
Forwarding from 127.0.0.1:9000 -> 9000
Forwarding from [::1]:9000 -> 9000

$ kubectl get services --all-namespaces
NAMESPACE     NAME             TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)                      AGE
default       kubernetes       ClusterIP      10.43.0.1       <none>          443/TCP                      8m18s
kube-system   kube-dns         ClusterIP      10.43.0.10      <none>          53/UDP,53/TCP,9153/TCP       8m16s
kube-system   metrics-server   ClusterIP      10.43.138.9     <none>          443/TCP                      8m16s
default       traefik          LoadBalancer   10.43.145.129   192.168.160.2   80:30192/TCP,443:31549/TCP   5m33s
default       whoami           ClusterIP      10.43.224.225   <none>          80/TCP                       2m36s
----

* Browse https://localhost/ to see whoami page



----

== Resources

* link:https://k3d.io/usage/commands/[Commands]
* link:https://github.com/inercia/k3x[K3D UI]

* Demos:
** link:https://github.com/iwilltry42/k3d-demo[Demo] (do not run make prep !!!)
** link:https://blog.gabrielsagnard.fr/gerer-les-clusters-k3s-avec-k3d/[Outdated but interesting]
** link:https://codeburst.io/creating-a-local-development-kubernetes-cluster-with-k3s-and-traefik-proxy-7a5033cb1c2d[CodeBurst Whoami]